{% extends "postman/base.html" %}
{% load i18n postman_tags widget_tweaks cosinnus_tags thumbnail %}

{% block page_title %}{% trans "Message" %}{{ block.super }}{% endblock %}

{% block breadcrumb %}
    {{ block.super }}
    
    {% with pm_messages.all|first as message %}
	    {% if message.sender == user %}
	       {% if message.sender_deleted_at %}
               <li class="active"><a href="{% url 'postman_trash' %}">{% trans "Trash" %}</a></li>	       
	       {% elif message.sender_archived %}
               <li class="active"><a href="{% url 'postman_archives' %}">{% trans "Archive" %}</a></li>         
           {% else %}
	           <li class="active"><a href="{% url 'postman_sent' %}">{% trans "Sent" %}</a></li>
	       {% endif %}
	    {% else %}
	       {% if message.recipient_deleted_at %}
               <li class="active"><a href="{% url 'postman_trash' %}">{% trans "Trash" %}</a></li>         
           {% elif message.recipient_archived %}
               <li class="active"><a href="{% url 'postman_archives' %}">{% trans "Archive" %}</a></li>         
           {% else %}
               <li class="active"><a href="{% url 'postman_inbox' %}">{% trans "Inbox" %}</a></li>
           {% endif %}
	    {% endif %}
        <li class="active">{% if pm_messages|length > 1 %}{% trans "Conversation" %}{% else %}{% trans "Message" %}{% endif %}: {{ message.subject }}</li>
    {% endwith %}
{% endblock %}

{% block postman_content %}

<!-- a box with semi transparent background -->
<div class="content-box">
    
    {% for message in pm_messages reversed %}
    
	    <div class="btn btn-{% if message.sender == user %}extra-{% endif %}emphasized w100">
	        <ul class="media-list">
	            <li class="media">
	                <a class="pull-left" href="{{ message.sender|profile_url }}">
	                    {% include "cosinnus/user/user_avatar_image.html" with user=message.sender %}
	                </a>
	                <div class="media-body">
	                    <a href="{{ message.sender|profile_url }}">
	                        <span class="annotation moment-data-date" data-date="{{ message.sent_at|date:"c" }}"></span>
	                        <strong>{% if message.sender == user %}<i>{% trans "Me" %}</i>{% else %}{{ message.sender|full_name }}{% endif %}</strong>
	                    </a>
	                    {% if not message.recipient == user %}
		                    &gt;
		                    <a href="{{ message.recipient|profile_url }}">
	                            <strong>{% if message.recipient == user %}<i>{% trans "Me" %}</i>{% else %}{{ message.recipient|full_name }}{% endif %}</strong>
	                        </a>
                        {% endif %}
	                </div>
	            </li>
	        </ul>
	    </div>
	    <p class="regular-space">{{ message.body|urlize|url_target_blank|linebreaksbr }}</p>
    
    {% endfor %}

    {% if reply_to_pk %}
    <form action="{% url 'postman_reply' reply_to_pk %}?next={{ next_url|urlencode }}" method="post">{% csrf_token %}
	    
	    <div class="btn btn-emphasized w100">
	        <ul class="media-list">
	            <li class="media">
	                <a class="pull-left" href="#">
	                    <i class="fa fa-pencil"></i>
	                </a>
	                <div class="media-body">
                        {% trans "Answer" %}
	                </div>
	            </li>
	        </ul>
	    </div>
	    
	    <div class="btn btn-default w100">
            <ul class="media-list">
                <li class="media">
                    <div class="media-body">
                        {% captureas label %}{% trans "Reply..." %}{% endcaptureas %}
                        {% render_field form.body class+="app-message-text next-button-is-for-sending" placeholder=label %}
                    </div>
                </li>
            </ul>
        </div>
	    <button type="submit" class="btn btn-emphasized" style="display: none;">
            <ul class="media-list">
                <li class="media">
                    <a class="pull-left" href="#">
                        <i class="fa fa-pencil"></i>
                    </a>
                    <div class="media-body">
                        {% trans "Reply" %}
                    </div>
                </li>
            </ul>
        </button>
	</form>
    {% endif %}

</div><!-- content-box -->

{% with pm_messages.all|first as message %}

	<form action="" method="post">{% csrf_token %}
		<input type="hidden" {% if pm_messages|length > 1 and message.thread_id %}name="tpks" value="{{ message.thread_id }}"{% else %}name="pks" value="{{ message.pk }}"{% endif %} />
		
		<button type="submit"  onclick="this.form.action='{% url 'postman_delete' %}?next={{ next_url|urlencode }}'" class="btn btn-emphasized">
		    <ul class="media-list">
		        <li class="media">
		            <a class="pull-left" href="#">
		                <i class="fa fa-eraser"></i>
		            </a>
		            <div class="media-body">
		                {% trans "Delete" %}
		            </div>
		        </li>
		    </ul>
		</button>
		
		{% if not archived %}
		<button type="submit" onclick="this.form.action='{% url 'postman_archive' %}?next={{ next_url|urlencode }}'" class="btn btn-emphasized">
		    <ul class="media-list">
		        <li class="media">
		            <a class="pull-left" href="#">
		                <i class="fa fa-folder"></i>
		            </a>
		            <div class="media-body">
		                {% trans "Archive" %}
		            </div>
		        </li>
		    </ul>
		</button>
		{% endif %}
		
	</form>

{% endwith %}

{% endblock %}